<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="script-src file://* https://* 'unsafe-eval' 'unsafe-inline' 'self'">
    <style>
      * {
        font-family: monospace;
      }

      :root {
        background-color: black;
        color: white;
      }

      body, p, h1, h2 {
        padding: 0;
        margin: 0;
      }

      body {
        --gap-small: 1em;
        --gap-standard: 2em;
        --gap-large: 4em;
        --app-padding: var(--gap-standard);
        max-width: 100vw;
        min-height: 100vh;
        max-height: 100vh;
        overflow: hidden;
        padding: var(--app-padding);
      }

      .app {
        width: calc(100vw - 2 * var(--app-padding));
        height: calc(100vh - 2 * var(--app-padding));
        display: grid;
        grid-template-columns: 1fr 16em;
        grid-template-rows: min-content 1fr;
        gap: var(--gap-standard);
      }

      aside {
        display: flex;
        flex-direction: column;
        gap: var(--gap-standard);
      }

      select,
      button {
        padding: .6em .3em;
      }

      h2 {
        text-transform: uppercase;
        font-size: 1.2rem;
      }

      #canvas {
        grid-row: span 2;
        border: .2em dashed white;
        display: block;
        width: 100%;
        height: 100%;
        /* height: 700px; */
      }

      .stats {
        display: flex;
        flex-direction: column;
        gap: .2em;
      }

      .stats > * {
        display: flex;
        flex-direction: row;
      }

      .stats > * > :first-child {
        flex-basis: 10em;
      }

      .horizontal-equal {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--gap-small);
      }

      .small-gap {
        display: flex;
        flex-direction: column;
        gap: var(--gap-small);
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <canvas id="canvas"></canvas>

      <h1>
        Game of Life
      </h1>

      <aside>

        <section class="small-gap">
          <h2>Board</h2>
          <form class="small-gap">
            <select id="board_template_type">
              <option value="random">Random (50% alive)</option>
              <option value="predefined">Predefined template</option>
              <option value="custom">Custom template</option>
            </select>
            <select id="predefined_board_template_id">
              <option value="r-pentomino">R-pentomino</option>
              <option value="puffer-train-1">Puffer train #1 (Gosper, 1971)</option>
              <option value="puffer-train-2">Puffer train #2 (Schank, 2014)</option>
              <option value="p60-gun">p60 gun (Gosper, 1970)</option>
              <option value="shuttle">Shuttle (Beluchenko, 1970)</option>
              <option value="washerwoman">Washerwoman (Abbe, 1971)</option>
            </select>
            <textarea id="custom_board_template_string"></textarea>
            <button data-action="generate_board">Generate</button>
          </form>
        </section>

        <section class="small-gap">
          <h2>Gameplay</h2>
          <div class="horizontal-equal">
            <button data-action="start_gameplay">Start</button>
            <button data-action="stop_gameplay">Stop</button>
            <button data-action="step_gameplay">Step</button>
          </div>
        </section>

        <section class="small-gap">
          <h2>Stats</h2>
          <section class="stats">
            <p><span>Generation</span><span id="generation">&mdash;</span></p>
            <!-- <p><span>Population</span><span id="population">&mdash;</span></p> -->
            <p><span>Evolution time</span><span id="evolution-time">&mdash;</span></p>
            <p><span>Paint time</span><span id="paint-time">&mdash;</span></p>
          </section>
        </section>

      </aside>
    </div>

    <script src="js/main.js"></script>

    <script>
      let $ = document.querySelector.bind(document)
      let $$ = (x) => Array.from(document.querySelectorAll(x))

      let getState = () => ({
        boardTemplateType: $('#board_template_type').value,
        predefinedTemplateId: $('#predefined_board_template_id').value,
        customTemplateString: $('#custom_board_template_string').value
      })

      let render = (state) => {
        switch (state.boardTemplateType) {
          case 'random':
            $('#predefined_board_template_id').classList.add('hidden')
            $('#custom_board_template_string').classList.add('hidden')
            break
          case 'predefined':
            $('#predefined_board_template_id').classList.remove('hidden')
            $('#custom_board_template_string').classList.add('hidden')
            break
          case 'custom':
            $('#predefined_board_template_id').classList.add('hidden')
            $('#custom_board_template_string').classList.remove('hidden')
            break
          default:
            throw Error(`Unknown board template type: '${state.boardTemplateType}'.`)
        }
      }

      let handleAction = (action) => {
        let state = getState()

        switch (action) {
            case 'generate_board':
              switch (state.boardTemplateType) {
                case 'random':
                  game_of_life.main.set_random_board(game)
                  break
                case 'predefined':
                  game_of_life.main.set_board_from_template_id(game, state.predefinedTemplateId)
                  break
                case 'custom':
                  game_of_life.main.set_board_from_template_string(game, state.customTemplateString)
                  break
                default:
                  throw Error(`Unknown board template type: '${state.boardTemplateType}'.`)
              }
              break
            case 'start_gameplay':
            case 'stop_gameplay':
            case 'step_gameplay':
              game_of_life.main[action](game)
              break
            default:
              alert('Error')
              null
          }
      }

      render(getState())

      let callback = (stats) => {
        $('#generation').textContent = stats.generation
        $('#evolution-time').textContent = `${stats.evolution_time.toFixed(0)} ms`
        $('#paint-time').textContent = `${stats.paint_time.toFixed(0)} ms`
      }

      let game = game_of_life.main.create_game($('#canvas'), callback)
      game_of_life.main.set_random_board(game)

      $$('button').forEach((button) => {
        button.addEventListener('click', (event) => {
          event.preventDefault()
          let action = event.target.dataset.action
          handleAction(action)
        })
      })

      $$('select').forEach((select) => {
        select.addEventListener('change', (event) => {
          render(getState())
        })
      })

    </script>
  </body>
</html>
